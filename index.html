<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Archivio Gare Cavalli</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .gara-container {
      margin-bottom: 30px;
    }
    .gara {
      width: 100%;
      position: relative;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
      position: relative;
    }
    input[type="text"], input[type="number"] {
      width: 90%;
      padding: 4px;
    }
    input.quota {
      width: 60px;
    }
    button {
      margin-top: 5px;
      margin-right: 10px;
    }
    .autocomplete-items {
      position: absolute;
      border: 1px solid #ccc;
      background-color: #fff;
      z-index: 99;
      max-height: 150px;
      overflow-y: auto;
      top: 100%;
      left: 0;
      right: 0;
    }
    .autocomplete-items div {
      padding: 5px;
      cursor: pointer;
    }
    .autocomplete-items div:hover {
      background-color: #f0f0f0;
    }
    #report {
      margin-top: 20px;
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 10px;
      white-space: pre-wrap;
      font-family: monospace;
    }
    #importFile {
      display: none;
    }
  </style>
</head>
<body>
<h2>Archivio Gare Cavalli</h2>

<div class="gara-container">
  <div class="gara">
    <table id="gara1">
      <thead><tr><th>Corsia</th><th>Nome</th><th>Quota</th></tr></thead>
      <tbody id="body1"></tbody>
    </table>
    <button onclick="salvaGara(1)">Salva</button>
    <button onclick="pulisciTabella(1)">Pulisci Tabella</button>
    <button onclick="cercaGare()">Cerca</button>
    <button onclick="startVoiceInput()">üéôÔ∏è Detta cavalli</button>
  </div>
</div>

<button onclick="cancellaTutto()">Cancella Tutto (Storage)</button>
<button onclick="mostraTutteGare()">Mostra tutte le gare salvate</button>
<button onclick="exportBackup()">Backup dati (JSON)</button>
<button onclick="exportCSV()">Esporta in CSV</button>
<button onclick="document.getElementById('importFile').click()">Importa backup (JSON)</button>
<button onclick="eliminaGaraPopup()">üóëÔ∏è Elimina Gara</button>
<button onclick="eliminaTrisSingolaPopup()">‚ûñ Elimina una Tris</button>
<input type="file" id="importFile" accept=".json" onchange="importaBackup(event)">

<div id="report"></div>
<script>
const NUM_CORSIE = 6;

function inizializzaTabella() {
  const tbody = document.getElementById("body1");
  tbody.innerHTML = ""; // pulizia per evitare duplicati
  for (let i = 1; i <= NUM_CORSIE; i++) {
    const row = document.createElement("tr");

    const cellCorsia = document.createElement("td");
    cellCorsia.textContent = i;

    const cellNome = document.createElement("td");
    const inputNome = document.createElement("input");
    inputNome.type = "text";
    inputNome.id = `nome1_${i}`;
    inputNome.name = `cavallo${i}`;
    inputNome.className = "nome";
    inputNome.autocomplete = "off";
    cellNome.appendChild(inputNome);

    const cellQuota = document.createElement("td");
    const inputQuota = document.createElement("input");
    inputQuota.type = "number";
    inputQuota.step = "0.01";
    inputQuota.inputMode = "decimal";
    inputQuota.pattern = "[0-9]*";
    inputQuota.id = `quota1_${i}`;
    inputQuota.name = `quota${i}`;
    inputQuota.className = "quota";
    cellQuota.appendChild(inputQuota);

    row.appendChild(cellCorsia);
    row.appendChild(cellNome);
    row.appendChild(cellQuota);

    tbody.appendChild(row);
  }
}

// Backup automatico
setInterval(() => {
  const gare = localStorage.getItem("gare");
  if (gare) localStorage.setItem("backup_gare", gare);
}, 60000);

// Backup manuale
function exportBackup() {
  const data = localStorage.getItem("gare") || "[]";
  const blob = new Blob([data], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `gare_backup_${new Date().toISOString().slice(0, 10)}.json`;
  link.click();
}

// Importa backup
function importaBackup(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const dati = JSON.parse(e.target.result);
      if (Array.isArray(dati)) {
        localStorage.setItem("gare", JSON.stringify(dati));
        alert("Backup importato con successo.");
      } else {
        alert("Formato file non valido.");
      }
    } catch {
      alert("Errore nella lettura del file.");
    }
  };
  reader.readAsText(file);
}
function capitalize(str) {
  if (!str) return "";
  return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}
function getGaraData(numeroGara) {
  const nomi = [];
  const quote = [];

  document.querySelectorAll(`#gara${numeroGara} input[name^="cavallo"]`).forEach(input => {
    nomi.push(capitalize(input.value.trim()));
  });

  document.querySelectorAll(`#gara${numeroGara} input[name^="quota"]`).forEach(input => {
    quote.push(input.value.trim());
  });

  return { nomi, quote };
}

function mostraReport(testo) {
  document.getElementById("report").textContent = testo;
}

function salvaGara(index) {
  const { nomi, quote } = getGaraData(index);
  if (nomi.includes("") || quote.includes("")) {
    alert("Compila tutti i campi prima di salvare.");
    return;
  }

  let gare = JSON.parse(localStorage.getItem("gare") || "[]");

  const quoteStr = JSON.stringify(quote.map(q => parseFloat(q).toFixed(2)));
  const nomiStr = JSON.stringify(nomi);

  // Gara identica gi√† salvata
  const garaEsatta = gare.find(g => JSON.stringify(g.nomi) === nomiStr && JSON.stringify(g.quote.map(q => parseFloat(q).toFixed(2))) === quoteStr);
  if (garaEsatta) {
    let msg = "Questa gara esiste gi√†.\nTris salvate:\n";
    msg += garaEsatta.tris.map(t => `‚Üí ${t.combinazione} (Quota: ${t.quota})`).join("\n");
    if (confirm(msg + "\n\nVuoi salvare comunque un'altra tris?")) {
      let tris = prompt("Inserisci nuova tris vincente (es. 1,4,5):");
      if (!tris || tris.split(",").length !== 3) return alert("Formato tris non valido.");
      let quotaTris = prompt("Quota tris (es. 18.5):");
      if (!quotaTris || isNaN(parseFloat(quotaTris))) return alert("Quota non valida.");
      if (garaEsatta.tris.some(t => t.combinazione === tris && parseFloat(t.quota) === parseFloat(quotaTris))) {
        alert("‚úÖ Abbiamo vinto allora!");
        return;
      }
      garaEsatta.tris.push({ combinazione: tris, quota: parseFloat(quotaTris) });
      localStorage.setItem("gare", JSON.stringify(gare));
      alert("Tris aggiunta con successo.");
      return;
    } else {
      return;
    }
  }

  // Quote uguali, cavalli diversi
  const gareStessaQuota = gare.filter(g => JSON.stringify(g.quote.map(q => parseFloat(q).toFixed(2))) === quoteStr && JSON.stringify(g.nomi) !== nomiStr);
  if (gareStessaQuota.length > 0) {
    let msg = `‚ö†Ô∏è Questa combinazione di quote √® gi√† presente in ${gareStessaQuota.length} gara/e con cavalli diversi.\n`;
    gareStessaQuota.forEach((g, i) => {
      msg += `\nGara ${i + 1} ‚Üí Tris vincenti:\n${g.tris.map(t => `‚Üí ${t.combinazione} (Quota: ${t.quota})`).join("\n")}`;
    });
    alert(msg);
  }

  // Nomi uguali, quote diverse
  const gareStessiNomi = gare.filter(g => JSON.stringify(g.nomi) === nomiStr && JSON.stringify(g.quote.map(q => parseFloat(q).toFixed(2))) !== quoteStr);
  if (gareStessiNomi.length > 0) {
    let msg = "‚ö†Ô∏è Esiste gi√† una gara con gli stessi cavalli ma quote differenti:\n";
    gareStessiNomi.forEach((g, i) => {
      msg += `\nGara ${i + 1} ‚Üí Quote: ${g.quote.join(", ")}\nTris:\n${g.tris.map(t => `‚Üí ${t.combinazione} (Quota: ${t.quota})`).join("\n")}`;
    });
    if (!confirm(msg + "\n\nVuoi salvare comunque?")) return;
  }

  // Analisi AI prima del salvataggio
  const reportAI = analisiAIAvanzata(nomi, quote, gare);
  if (!confirm("Vuoi procedere con il salvataggio della gara dopo l‚Äôanalisi AI?")) {
    mostraReport(reportAI.reportTesto);
    return;
  }

  let tris = prompt("Inserisci tris vincente (es. 2,5,6):");
  if (!tris || tris.split(",").length !== 3) return alert("Formato tris non valido.");

  let quotaTris = prompt("Quota tris (es. 12.5):");
  if (!quotaTris || isNaN(parseFloat(quotaTris))) return alert("Quota non valida.");

  const nuovaGara = {
    nomi,
    quote: quote.map(q => parseFloat(q)),
    tris: [{ combinazione: tris, quota: parseFloat(quotaTris) }]
  };

  gare.push(nuovaGara);
  localStorage.setItem("gare", JSON.stringify(gare));

  alert("‚úÖ Gara salvata con successo.");
  aggiornaAnalisiAI?.();
}

function analisiAIAvanzata(nomi, quote, gare) {
  const cavalli = nomi.map((nome, i) => ({
    nome,
    quota: parseFloat(quote[i]),
    corsia: i + 1,
  }));

  const patternQuote = cavalli.map(c => {
    if (c.quota <= 2.5) return "B";
    if (c.quota <= 6.5) return "M";
    if (c.quota <= 9.9) return "A";
    return "SA";
  });

  const sommaQuote = cavalli.reduce((a, c) => a + c.quota, 0).toFixed(2);
  const favorito = cavalli.reduce((a, b) => a.quota < b.quota ? a : b);
  const sfavorito = cavalli.reduce((a, b) => a.quota > b.quota ? a : b);

  let report = `üìä Pattern quote: ${patternQuote.join("-")}\n`;
  report += `üßÆ Somma quote: ${sommaQuote}\n\n`;
  report += `üèá Cavallo favorito: ${favorito.nome} (Corsia ${favorito.corsia}, Quota ${favorito.quota})\n`;
  report += `üê¢ Cavallo sfavorito: ${sfavorito.nome} (Corsia ${sfavorito.corsia}, Quota ${sfavorito.quota})\n`;

  const analisiFavorito = analisiStoricaPerCorsia(favorito.corsia, favorito.quota, "vittorie");
  const analisiSfavorito = analisiStoricaPerCorsia(sfavorito.corsia, sfavorito.quota, "podi");
  report += `üéØ Storico favorito: ${analisiFavorito}\n`;
  report += `ü§û Storico sfavorito: ${analisiSfavorito}\n\n`;

  const cavalliStorici = caricaStoricoCavalli();
  const cavalliRicorrenti = cavalli.map(c => {
    const record = cavalliStorici[c.nome.toLowerCase()];
    if (record) {
      return `‚Üí ${c.nome}: ${record.podi} podi (${record.primi || 0}ü•á, ${record.secondi || 0}ü•à, ${record.terzi || 0}ü•â) su ${record.totali} gare | Quota media: ${record.quotaMedia}`;
    }
    return null;
  }).filter(Boolean);
  if (cavalliRicorrenti.length) {
    report += `üìå Cavalli ricorrenti:\n${cavalliRicorrenti.join("\n")}\n\n`;
  }

  report += `üìä Analisi quote per corsia:\n`;
  cavalli.forEach(c => {
    const info = analizzaQuotaECorsia(c.corsia, c.quota);
    report += `‚Üí Corsia ${c.corsia}, quota ${c.quota} ${info}\n`;
  });

  const tris = suggerisciTrisAI(cavalli);
  if (tris.length === 3) {
    const patternTris = tris.map(c => {
      if (c.quota <= 2.5) return "B";
      if (c.quota <= 6.5) return "M";
      if (c.quota <= 9.9) return "A";
      return "SA";
    });
    const sommaTris = tris.reduce((a, b) => a + b.quota, 0).toFixed(2);
    report += `\nü§ñ Predizione Tris AI: ${tris.map(c => c.corsia).join("-")} (${patternTris.join("-")}, somma quote: ${sommaTris})\n`;
  } else {
    report += `\nü§ñ Predizione Tris AI: Non abbastanza dati per una predizione affidabile.\n`;
  }

  return {
    trisAI: tris,
    reportTesto: report,
  };
}
function analizzaQuotaECorsia(corsia, quota) {
  const datiStorici = {
    1: { vincenti: [2.0, 5.0], podio: [2.0, 7.0], tossiche: [7.5, 9.0] },
    2: { vincenti: [2.0, 4.0], podio: [2.0, 8.0], tossiche: [25.0, 40.0] },
    3: { vincenti: [1.5, 3.0], podio: [1.5, 6.0], tossiche: [10.0, 15.0] },
    4: { vincenti: [3.5, 5.5], podio: [3.0, 7.0], tossiche: [8.5, 10.0] },
    5: { vincenti: [5.0, 6.5], podio: [4.0, 7.0], tossiche: [12.0, 20.0] },
    6: { vincenti: [3.5, 6.5], podio: [3.0, 7.5], tossiche: [15.0, 30.0] },
  };

  const d = datiStorici[corsia];
  let messaggio = "";
  if (!d) return "";

  if (quota >= d.vincenti[0] && quota <= d.vincenti[1]) messaggio += "üéØ range vincente ";
  if (quota >= d.podio[0] && quota <= d.podio[1]) messaggio += "üëç range podio ";
  if (quota >= d.tossiche[0] && quota <= d.tossiche[1]) messaggio += "‚ö†Ô∏è range tossico";

  return messaggio.trim();
}
function setupAutocomplete() {
  const inputs = document.querySelectorAll("input.nome");
  const cavalli = new Set();
  const gare = JSON.parse(localStorage.getItem("gare") || "[]");
  gare.forEach(g => g.nomi.forEach(n => cavalli.add(n)));

  inputs.forEach(input => {
    input.addEventListener("input", function() {
      closeLists();
      const val = this.value;
      if (!val) return;
      const list = document.createElement("div");
      list.setAttribute("class", "autocomplete-items");
      this.parentNode.appendChild(list);

      [...cavalli].forEach(nome => {
        if (nome.toLowerCase().startsWith(val.toLowerCase())) {
          const div = document.createElement("div");
          div.innerHTML = `<strong>${nome.substr(0, val.length)}</strong>${nome.substr(val.length)}<input type='hidden' value='${nome}'>`;
          div.addEventListener("click", () => {
            input.value = nome;
            closeLists();
          });
          list.appendChild(div);
        }
      });
    });
    input.addEventListener("blur", () => setTimeout(closeLists, 100));
  });
}

function closeLists() {
  const items = document.querySelectorAll(".autocomplete-items");
  items.forEach(item => item.remove());
}

function cercaGare() {
  const nome = document.getElementById("nome1_1").value.trim().toLowerCase();
  const gare = JSON.parse(localStorage.getItem("gare") || "[]");
  const risultati = gare.filter(g => g.nomi[0].toLowerCase() === nome);
  if (risultati.length === 0) return alert("Nessuna gara trovata con quel cavallo in corsia 1.");

  let index = 0;
  const win = window.open("", "Risultati Ricerca", "width=600,height=400");

  function mostraGara(i) {
    const g = risultati[i];
    win.document.body.innerHTML = `
      <h3>Gara ${i + 1} di ${risultati.length}</h3>
      <ul>
        ${g.nomi.map((n, idx) => `<li>Corsia ${idx + 1}: ${n} (Quota: ${g.quote[idx]})</li>`).join("")}
      </ul>
      <p><strong>Tris vincenti:</strong><br>
        ${g.tris.map(t => `‚Üí ${t.combinazione} (Quota: ${t.quota})`).join("<br>")}
      </p>
      <button onclick="window.opener.prevGara()">&larr;</button>
      <button onclick="window.opener.nextGara()">&rarr;</button>
    `;
  }

  window.prevGara = () => {
    if (index > 0) index--;
    mostraGara(index);
  };

  window.nextGara = () => {
    if (index < risultati.length - 1) index++;
    mostraGara(index);
  };

  mostraGara(index);
}
function mostraTutteGare() {
  const gare = JSON.parse(localStorage.getItem("gare") || "[]");
  if (gare.length === 0) return alert("Nessuna gara salvata.");
  
  const win = window.open("", "Gare Salvate", "width=600,height=600,scrollbars=yes");

  win.document.body.innerHTML = `
    <h2>${gare.length} Gare Salvate</h2>
    ${gare.map((g, idx) => `
      <h3>Gara ${idx + 1}</h3>
      <ul>
        ${g.nomi.map((n, i) => `<li>Corsia ${i + 1}: ${n} (Quota: ${g.quote[i]})</li>`).join("")}
      </ul>
      <p><strong>Tris:</strong><br>
        ${g.tris.map(t => `‚Üí ${t.combinazione} (Quota: ${t.quota})`).join("<br>")}
      </p>
      <hr>
    `).join("")}
  `;
}

function cancellaTutto() {
  if (confirm("Sicuro di voler eliminare tutte le gare?")) {
    localStorage.removeItem("gare");
    alert("Gare eliminate.");
    document.getElementById("report").textContent = "";
  }
}

function exportCSV() {
  const gare = JSON.parse(localStorage.getItem("gare") || "[]");
  if (gare.length === 0) return alert("Nessuna gara da esportare.");

  let csv = "Gara;Corsia;Nome;Quota;Tris Vincente;Quota Tris\n";

  gare.forEach((g, idx) => {
    g.nomi.forEach((nome, i) => {
      g.tris.forEach(t => {
        csv += `${idx + 1};${i + 1};${nome};${g.quote[i]};${t.combinazione};${t.quota}\n`;
      });
    });
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `gare_export_${new Date().toISOString().slice(0, 10)}.csv`;
  link.click();
}
function eliminaGaraPopup() {
  const gare = JSON.parse(localStorage.getItem("gare") || "[]");
  if (gare.length === 0) {
    alert("Nessuna gara salvata.");
    return;
  }

  const id = prompt(`Inserisci il numero ID della gara da eliminare (1-${gare.length}):`);
  if (!id || isNaN(id)) {
    alert("ID non valido.");
    return;
  }

  const index = parseInt(id) - 1;
  if (index < 0 || index >= gare.length) {
    alert("ID fuori intervallo.");
    return;
  }

  const gara = gare[index];
  const conferma = confirm(
    `Vuoi davvero eliminare la gara #${id}?\n\n` +
    gara.nomi.map((n, i) => `Corsia ${i + 1}: ${n} (Quota: ${gara.quote[i]})`).join("\n") +
    `\n\nTris:\n${gara.tris.map(t => `‚Üí ${t.combinazione} (Quota: ${t.quota})`).join("\n")}`
  );

  if (!conferma) return;

  gare.splice(index, 1);
  localStorage.setItem("gare", JSON.stringify(gare));
  alert(`Gara #${id} eliminata con successo.`);
  document.getElementById("report").textContent = "";
}
function eliminaTrisSingolaPopup() {
  const gare = JSON.parse(localStorage.getItem("gare") || "[]");
  if (gare.length === 0) {
    alert("Nessuna gara salvata.");
    return;
  }

  const id = prompt(`Inserisci il numero ID della gara da cui eliminare una tris (1-${gare.length}):`);
  if (!id || isNaN(id)) {
    alert("ID non valido.");
    return;
  }

  const index = parseInt(id) - 1;
  if (index < 0 || index >= gare.length) {
    alert("ID fuori intervallo.");
    return;
  }

  const gara = gare[index];
  if (gara.tris.length === 0) {
    alert("Questa gara non ha tris salvate.");
    return;
  }

  const listaTris = gara.tris.map((t, i) => `#${i + 1} ‚Üí ${t.combinazione} (Quota: ${t.quota})`).join("\n");
  const scelta = prompt(
    `Tris salvate nella gara #${id}:\n${listaTris}\n\nInserisci il numero della tris da eliminare:`
  );

  const trisIndex = parseInt(scelta) - 1;
  if (isNaN(trisIndex) || trisIndex < 0 || trisIndex >= gara.tris.length) {
    alert("Indice tris non valido.");
    return;
  }

  const conferma = confirm(`Vuoi davvero eliminare la tris #${scelta}: ${gara.tris[trisIndex].combinazione}?`);
  if (!conferma) return;

  gara.tris.splice(trisIndex, 1);
  localStorage.setItem("gare", JSON.stringify(gare));

  alert("Tris eliminata con successo.");
  document.getElementById("report").textContent = "";
}

function pulisciTabella(index) {
  for (let i = 1; i <= NUM_CORSIE; i++) {
    document.getElementById(`nome${index}_${i}`).value = "";
    document.getElementById(`quota${index}_${i}`).value = "";
  }
}

window.addEventListener("DOMContentLoaded", () => {
  inizializzaTabella();
  setupAutocomplete();
  startAIWatcher();
});

let riconosciuti = 0;
function startVoiceInput() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("Il tuo browser non supporta la dettatura vocale.");
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = "it-IT";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  alert("üéôÔ∏è Sono in ascolto...");

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    const righe = transcript
      .split(/[\n,;]+|\s+e\s+|\s+poi\s+/i)
      .map(s => s.trim())
      .filter(s => s);

    let cavalliInseriti = 0;

    // Trova il primo slot libero da compilare
    let indexPartenza = 1;
    for (let i = 1; i <= NUM_CORSIE; i++) {
      const nome = document.getElementById(`nome1_${i}`).value.trim();
      const quota = document.getElementById(`quota1_${i}`).value.trim();
      if (!nome || !quota) {
        indexPartenza = i;
        break;
      }
    }

    // Inserisci i dati dettati partendo dal primo slot libero
    for (let i = 0; i < righe.length && (indexPartenza + i) <= NUM_CORSIE; i++) {
      const riga = righe[i];
      const match = riga.match(/([A-Za-z√Ä-√ø'\- ]+)\s+(\d+(?:[.,]\d+)?)/);
      if (match) {
        const nome = match[1].trim();
        const quota = match[2].replace(",", ".");
        const idx = indexPartenza + i;

        const nomeInput = document.getElementById(`nome1_${idx}`);
        const quotaInput = document.getElementById(`quota1_${idx}`);

        if (nomeInput && quotaInput) {
          nomeInput.value = nome;
          quotaInput.value = quota;
          cavalliInseriti++;
        }
      }
    }

    alert(`‚úÖ ${cavalliInseriti} cavalli su ${NUM_CORSIE} inseriti correttamente.`);

    if (typeof aggiornaAnalisiAI === "function") {
      aggiornaAnalisiAI();
    }
  };

  recognition.onerror = function(event) {
    alert("‚ùå Errore durante la dettatura: " + event.error);
  };

  recognition.start();
}
function startAIWatcher() {
  let ultimaFirma = "";

  // Analisi iniziale se i dati sono gi√† completi
  const iniziale = getGaraData(1);
  if (!iniziale.nomi.includes("") && !iniziale.quote.includes("")) {
    const gare = JSON.parse(localStorage.getItem("gare") || "[]");
    const reportAI = analisiAIAvanzata(iniziale.nomi, iniziale.quote, gare);
    mostraReport(reportAI.reportTesto);
    ultimaFirma = iniziale.nomi.join("|") + "::" + iniziale.quote.join("|");
    aggiornaBadgeOrario();
  }

  // Tooltip su ogni input cavallo o quota (facoltativo, ma utile)
  document.querySelectorAll("#gara1 input").forEach(input => {
    input.title = "Modifica per aggiornare l'analisi AI";
  });

  // Badge orario AI
  let badge = document.getElementById("badgeAI");
  if (!badge) {
    badge = document.createElement("div");
    badge.id = "badgeAI";
    badge.style.position = "absolute";
    badge.style.top = "10px";
    badge.style.right = "10px";
    badge.style.padding = "6px 12px";
    badge.style.background = "#d0ebff";
    badge.style.border = "1px solid #339af0";
    badge.style.borderRadius = "8px";
    badge.style.fontSize = "12px";
    badge.style.fontFamily = "monospace";
    badge.style.zIndex = 999;
    document.body.appendChild(badge);
  }

function aggiornaBadgeOrario() {
  const ora = new Date();
  const orario = ora.toLocaleTimeString("it-IT", { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  badge.innerText = `AI aggiornata alle ${orario}`;
}

// Watcher ogni secondo
setInterval(() => {
  const { nomi, quote } = getGaraData(1);
  if (nomi.includes("") || quote.includes("")) return;

  const firmaAttuale = nomi.join("|") + "::" + quote.join("|");
  if (firmaAttuale === ultimaFirma) return;

  const gare = JSON.parse(localStorage.getItem("gare") || "[]");
  const reportAI = analisiAIAvanzata(nomi, quote, gare);
  mostraReport(reportAI.reportTesto);

  ultimaFirma = firmaAttuale;
  aggiornaBadgeOrario();
}, 1000);
}

function mostraOrarioAggiornamento() {
  const now = new Date();
  const orario = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  const div = document.getElementById("ai-status");
  if (div) {
    div.textContent = `üîÑ Analisi aggiornata alle ${orario}`;
  } else {
    const newDiv = document.createElement("div");
    newDiv.id = "ai-status";
    newDiv.style = "margin-top:5px; font-size: 0.9em; color: gray;";
    newDiv.textContent = `üîÑ Analisi aggiornata alle ${orario}`;
    document.getElementById("report-ai")?.appendChild(newDiv);
  }
}

function mostraBadgeNuoviCavalli(nomi, gare) {
  const storici = gare.flatMap(g => g.nomi);
  document.querySelectorAll("#tabella-gara-1 input.nome").forEach(input => {
    if (!input.value) return;
    const esiste = storici.includes(input.value.trim());
    input.style.border = esiste ? "" : "2px solid orange";
    input.title = esiste ? "" : "üÜï Cavallo mai visto prima nello storico!";
  });
}

function mostraTooltipQuote(quote, gare) {
  const quoteMap = {};

  gare.forEach(g => {
    g.quote.forEach((q, i) => {
      const val = parseFloat(q);
      if (!quoteMap[val]) quoteMap[val] = { podi: 0, tot: 0 };

      const corsiePodio = g.tris.flatMap(t => t.combinazione.split(",").map(n => parseInt(n)));
      if (corsiePodio.includes(i + 1)) quoteMap[val].podi++;
      quoteMap[val].tot++;
    });
  });

  document.querySelectorAll("#tabella-gara-1 input.quota").forEach(input => {
    const val = parseFloat(input.value);
    if (!val || !quoteMap[val]) return;

    const data = quoteMap[val];
    const perc = ((data.podi / data.tot) * 100).toFixed(1);
    input.title = `üìä Quota ${val} ‚Üí ${perc}% podio su ${data.tot} casi`;
  });
}

// ‚úÖ Registrazione del Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('service-worker.js')
      .then(function(registration) {
        console.log('‚úÖ ServiceWorker registrato con successo:', registration.scope);
      })
      .catch(function(error) {
        console.error('‚ùå Errore nella registrazione del ServiceWorker:', error);
      });
  });
}
</script>

</body>
</html>
